#!/bin/sh
[ -n "$BACKUP_OUTPUT" ] && exec > $BACKUP_OUTPUT 2>&1
if [ $EUID -ne 0 ]
then
    echo "`date`: Must be run as root"
    exit 1
fi

__cleanup()
{
    if [ -n "$BACKUP_MOUNTED" ]
    then
        umount $BACKUP_MOUNTPOINT
        echo "Backup location mounted"
        unset BACKUP_MOUNTED
    fi
}


echo "Beginning backup: `date`"

# Only do the following if backing up to a server
if [ -n "$BACKUP_SERVER" ]
then
    starttime=`date '+%s'`
    runningtime=0
    while [ $runningtime -le 120 ]
    do
        if ping -c 1 $BACKUP_SERVER > /dev/null 2>&1
        then
            connected=1
            break
        fi
        sleep 1
        runningtime=$((`date '+%s'` - $starttime))
    done

    if [ -n "$connected" ]
    then
        echo "$BACKUP_SERVER reachable. Proceeding."
    else
        echo "$BACKUP_SERVER NOT reachable. Exiting."
        echo "Ending backup: `date`"
        exit -1
    fi
fi

if [ -n "$BACKUP_MOUNTPOINT" ]
then
    if mount "$BACKUP_MOUNTPOINT" 2>&1
    then
        echo "Backup location successfully mounted"
        BACKUP_MOUNTED=1
    else
        echo "Backup location mount FAILED. Confirm entry in /etc/fstab."
        echo "Quitting."
        echo "Ending backup: `date`"
        exit -2
    fi
fi

BORG_PASSPHRASE=`cat $PASSFILE` borg create --stats \
    $BACKUP_MOUNTPOINT/$HOSTNAME.borg::`date '+%Y%m%d'` \
    $BACKUP_FOLDERS 2>&1

df | grep "Filesystem\|$BACKUP_MOUNTPOINT"
__cleanup
echo "Ending backup: `date`"
